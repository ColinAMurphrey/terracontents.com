<!doctype html>
<html lang="en">
<head>
  <!-- Should work idk -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>THE PAGE THAT WATCHES</title>
  <style>
    :root{
      --bg:#060607;
      --fg:#e7e7ea;
      --muted:#9a9aa3;
      --accent:#b3122d;
      --good:#7bd389;
      --warn:#ffcf5a;
      --shadow:rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 50% 35%, #0d0d11 0%, var(--bg) 55%, #000 100%);
      color:var(--fg);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      overflow:hidden;
      user-select:none;
    }
    /* subtle film grain */
    body::before{
      content:"";
      position:fixed; inset:-20%;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E");
      mix-blend-mode:overlay;
      opacity:.22;
      pointer-events:none;
      animation: drift 6s linear infinite;
    }
    @keyframes drift{0%{transform:translate(0,0)}100%{transform:translate(40px,30px)}}

    /* screen vignette */
    .vignette{
      position:fixed; inset:0;
      pointer-events:none;
      background: radial-gradient(closest-side at 50% 45%, transparent 40%, rgba(0,0,0,.65) 95%);
    }

    /* jitter on "panic" */
    .panic{
      animation: panic 140ms infinite;
    }
    @keyframes panic{
      0%{transform:translate(0,0)}
      25%{transform:translate(1px,-1px)}
      50%{transform:translate(-1px,1px)}
      75%{transform:translate(2px,0)}
      100%{transform:translate(0,0)}
    }

    /* main layout */
    .wrap{
      height:100%;
      display:grid;
      place-items:center;
      padding:24px;
    }
    .card{
      width:min(860px, 92vw);
      height:min(560px, 86vh);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: 0 18px 60px var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:18px 18px 0 18px;
      gap:12px;
    }
    .title{
      letter-spacing:.12em;
      font-size:12px;
      color:var(--muted);
      text-transform:uppercase;
    }
    .status{
      display:flex;
      align-items:center;
      gap:12px;
      font-size:12px;
      color:var(--muted);
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 18px rgba(179,18,45,.5);
      animation: pulse 1.8s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{transform:scale(.9);opacity:.6}
      50%{transform:scale(1.15);opacity:1}
    }

    .content{
      padding:18px;
      height:calc(100% - 52px);
      display:grid;
      grid-template-rows: 1fr auto;
      gap:16px;
    }
    .screen{
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      background: rgba(0,0,0,.35);
      padding:18px;
      overflow:auto;
      position:relative;
    }
    .screen::-webkit-scrollbar{width:10px}
    .screen::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:8px}
    .log{
      display:flex;
      flex-direction:column;
      gap:10px;
      line-height:1.35;
      font-size:15px;
    }
    .line{color:var(--fg)}
    .dim{color:var(--muted)}
    .accent{color:#ff4160}
    .good{color:var(--good)}
    .warn{color:var(--warn)}
    .glitch{
      position:relative;
      display:inline-block;
    }
    .glitch::before,
    .glitch::after{
      content:attr(data-text);
      position:absolute;
      left:0; top:0;
      opacity:.7;
      pointer-events:none;
      clip-path: inset(0 0 0 0);
    }
    .glitch::before{transform:translate(1px,0); color:#ff3b67; mix-blend-mode:screen}
    .glitch::after{transform:translate(-1px,0); color:#58e1ff; mix-blend-mode:screen}
    .glitching .glitch::before{animation:g1 700ms infinite linear}
    .glitching .glitch::after{animation:g2 640ms infinite linear}
    @keyframes g1{
      0%{clip-path: inset(0 0 85% 0)}
      20%{clip-path: inset(15% 0 55% 0)}
      40%{clip-path: inset(55% 0 25% 0)}
      60%{clip-path: inset(30% 0 55% 0)}
      80%{clip-path: inset(60% 0 10% 0)}
      100%{clip-path: inset(0 0 85% 0)}
    }
    @keyframes g2{
      0%{clip-path: inset(80% 0 0 0)}
      25%{clip-path: inset(50% 0 25% 0)}
      50%{clip-path: inset(10% 0 70% 0)}
      75%{clip-path: inset(35% 0 40% 0)}
      100%{clip-path: inset(80% 0 0 0)}
    }

    .choices{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:flex-start;
    }
    button{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      color:var(--fg);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font:inherit;
      letter-spacing:.02em;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    button:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.22);
    }
    button:active{transform:translateY(1px)}
    button.primary{
      border-color: rgba(179,18,45,.55);
      box-shadow: 0 0 0 2px rgba(179,18,45,.08) inset;
    }
    button.primary:hover{
      background: rgba(179,18,45,.12);
    }
    button.danger{
      border-color: rgba(255,65,96,.55);
    }
    button:disabled{
      opacity:.4;
      cursor:not-allowed;
    }

    /* creepy overlay "eyes" */
    .eyes{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:0;
      transition: opacity .9s ease;
      background:
        radial-gradient(14px 10px at 26% 42%, rgba(255,255,255,.22) 0 40%, transparent 41%),
        radial-gradient(14px 10px at 74% 42%, rgba(255,255,255,.22) 0 40%, transparent 41%),
        radial-gradient(20px 14px at 26% 42%, rgba(179,18,45,.22) 0 35%, transparent 36%),
        radial-gradient(20px 14px at 74% 42%, rgba(179,18,45,.22) 0 35%, transparent 36%);
      filter: blur(.2px);
      mix-blend-mode: screen;
    }
    .eyes.on{opacity:.7}

    /* modal */
    dialog{
      width:min(640px, 92vw);
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px;
      background: rgba(6,6,7,.92);
      color:var(--fg);
      box-shadow: 0 22px 90px rgba(0,0,0,.75);
      padding:0;
    }
    dialog::backdrop{
      background: rgba(0,0,0,.65);
    }
    .modal{
      padding:16px;
    }
    .modal h3{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .modal p{margin:0 0 12px 0; line-height:1.4}
    .modal .row{display:flex; gap:10px; flex-wrap:wrap}
    .kbd{
      display:inline-block;
      padding:2px 6px;
      border:1px solid rgba(255,255,255,.14);
      border-radius:7px;
      color:var(--muted);
      font-size:12px;
      margin-left:6px;
    }

    /* tiny footer */
    .hint{
      position:absolute;
      right:16px; bottom:14px;
      font-size:12px;
      color:rgba(255,255,255,.18);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <div class="eyes" id="eyes"></div>

      <div class="header">
        <div class="title">Interactive Document / Untrusted Content</div>
        <div class="status">
          <span class="dot" aria-hidden="true"></span>
          <span id="statusText">idle</span>
        </div>
      </div>

      <div class="content">
        <div class="screen" id="screen" tabindex="0" aria-label="Game screen">
          <div class="log" id="log"></div>
          <div class="hint" id="hint"></div>
        </div>

        <div class="choices" id="choices"></div>
      </div>
    </div>
  </div>

  <dialog id="dlg">
    <div class="modal">
      <h3 id="dlgTitle">NOTICE</h3>
      <p id="dlgBody"></p>
      <div class="row" id="dlgButtons"></div>
    </div>
  </dialog>

  <script>
    (() => {
      // ====== tiny helpers ======
      const $ = (sel) => document.querySelector(sel);
      const logEl = $("#log");
      const choicesEl = $("#choices");
      const screenEl = $("#screen");
      const cardEl = $("#card");
      const eyesEl = $("#eyes");
      const hintEl = $("#hint");
      const statusText = $("#statusText");

      const dlg = $("#dlg");
      const dlgTitle = $("#dlgTitle");
      const dlgBody = $("#dlgBody");
      const dlgButtons = $("#dlgButtons");

      const sleep = (ms) => new Promise(r => setTimeout(r, ms));
      const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
      const now = () => new Date();

      // ====== audio (creepy but optional) ======
      let audioCtx = null;
      function beep({freq=220, dur=0.08, type="sine", gain=0.02}={}){
        try{
          audioCtx ||= new (window.AudioContext || window.webkitAudioContext)();
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = type;
          o.frequency.value = freq;
          g.gain.value = gain;
          o.connect(g); g.connect(audioCtx.destination);
          o.start();
          o.stop(audioCtx.currentTime + dur);
        }catch(e){}
      }
      function chime(){
        beep({freq:330,dur:0.05,gain:0.02});
        setTimeout(()=>beep({freq:220,dur:0.07,gain:0.02,type:"triangle"}), 60);
      }

      // ====== state ======
      const state = {
        step: "boot",
        sanity: 6,     // affects creep intensity; lower = worse
        flags: new Set(),
        player: "YOU",
        startedAt: now(),
        cursorWants: false,
        lastMouseMove: performance.now(),
        moves: 0,
      };

      // ====== logging / rendering ======
      function addLine(html, cls="line"){
        const div = document.createElement("div");
        div.className = cls;
        div.innerHTML = html;
        logEl.appendChild(div);
        // auto-scroll
        screenEl.scrollTop = screenEl.scrollHeight;
      }

      function clearChoices(){
        choicesEl.innerHTML = "";
      }

      function addChoice(label, onClick, {kind="default", disabled=false}={}){
        const btn = document.createElement("button");
        btn.textContent = label;
        if(kind === "primary") btn.classList.add("primary");
        if(kind === "danger") btn.classList.add("danger");
        btn.disabled = disabled;
        btn.addEventListener("click", async () => {
          btn.disabled = true;
          await onClick();
        });
        choicesEl.appendChild(btn);
      }

      function setStatus(txt){
        statusText.textContent = txt;
      }

      function setHint(txt=""){
        hintEl.textContent = txt;
      }

      function glitchOn(on=true){
        screenEl.classList.toggle("glitching", on);
      }

      function setPanic(on=true){
        cardEl.classList.toggle("panic", on);
      }

      function eyes(on=true){
        eyesEl.classList.toggle("on", on);
      }

      function reduceSanity(n=1){
        state.sanity = clamp(state.sanity - n, 0, 10);
        // intensity knobs
        if(state.sanity <= 3){
          eyes(true);
          glitchOn(true);
        }
        if(state.sanity <= 1){
          setPanic(true);
        }
      }

      function restoreSanity(n=1){
        state.sanity = clamp(state.sanity + n, 0, 10);
        if(state.sanity > 3){
          eyes(false);
          glitchOn(false);
        }
        if(state.sanity > 1){
          setPanic(false);
        }
      }

      // ====== modal ======
      async function modal(title, body, buttons){
        dlgTitle.textContent = title;
        dlgBody.innerHTML = body;
        dlgButtons.innerHTML = "";
        return new Promise((resolve) => {
          buttons.forEach(b => {
            const btn = document.createElement("button");
            btn.textContent = b.label;
            if(b.kind) btn.classList.add(b.kind);
            btn.addEventListener("click", () => {
              dlg.close();
              resolve(b.value);
            });
            dlgButtons.appendChild(btn);
          });
          dlg.showModal();
        });
      }

      // ====== “HTML events” ======
      function attachUnsettlingEvents(){
        // 1) Mouse move tracking => page reacts
        window.addEventListener("mousemove", (e) => {
          state.lastMouseMove = performance.now();
          state.moves++;
          // occasionally whisper via UI changes
          if(state.moves % 60 === 0){
            setStatus("tracking");
            setTimeout(()=>setStatus("idle"), 650);
          }
        }, {passive:true});

        // 2) Tab switching => punish
        document.addEventListener("visibilitychange", () => {
          if(document.hidden){
            // leaving feels like a choice
            state.flags.add("looked_away");
          }else{
            if(state.flags.has("looked_away") && !state.flags.has("forgiven")){
              reduceSanity(1);
              addLine(`You looked away. The page waited.`, "warn");
              chime();
            }
          }
        });

        // 3) Idle detection => page "notices"
        setInterval(() => {
          const idleMs = performance.now() - state.lastMouseMove;
          if(idleMs > 6000 && !state.flags.has("idle_notice")){
            state.flags.add("idle_notice");
            addLine(`You stopped moving.`, "dim");
            addLine(`...is there someone behind you?`, "accent");
            beep({freq:140,dur:0.12,gain:0.03,type:"sawtooth"});
            reduceSanity(1);
          }
        }, 800);

        // 4) Keydown => hidden interactions
        window.addEventListener("keydown", (e) => {
          if(e.key === "Escape"){
            // ESC never helps
            addLine(`The <span class="glitch" data-text="ESC">ESC</span> key doesn't work here.`, "warn");
            beep({freq:88,dur:0.09,gain:0.03,type:"square"});
            reduceSanity(1);
          }
          if(e.key.toLowerCase() === "l"){
            // secret: "l" toggles a faint light
            state.flags.add("pressed_l");
            restoreSanity(1);
            addLine(`A weak light returns for a moment.`, "good");
            chime();
          }
        });
      }

      // ====== story nodes ======
      const nodes = {
        boot: async () => {
          setStatus("loading");
          setHint("Tip: sound is optional. Click anywhere if audio is blocked.");
          addLine(`<span class="dim">[document]</span> Attempting to render…`, "dim");
          await sleep(450);
          addLine(`The page opens like a door that doesn't want to.`, "line");
          await sleep(500);
          addLine(`A cursor blinks. Not yours.`, "accent");
          await sleep(300);
          addLine(`<span class="dim">A form field appears.</span>`, "dim");

          clearChoices();
          addChoice("Continue", () => go("name"), {kind:"primary"});
        },

        name: async () => {
          setStatus("input");
          clearChoices();

          const wrapper = document.createElement("div");
          wrapper.className = "line";
          wrapper.innerHTML = `
            <label class="dim">Enter your name to continue:</label><br/>
            <input id="nm" autocomplete="off" spellcheck="false"
              style="margin-top:8px;width:min(360px,90%);padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.35);color:var(--fg);font:inherit;outline:none;"
              placeholder="(it already knows, but pretend)" />
          `;
          logEl.appendChild(wrapper);
          screenEl.scrollTop = screenEl.scrollHeight;

          const nm = wrapper.querySelector("#nm");
          nm.focus();

          addChoice("Submit", async () => {
            const val = (nm.value || "").trim();
            state.player = val ? val.toUpperCase().slice(0,18) : "YOU";
            addLine(`Hello, <span class="glitch" data-text="${escapeHtml(state.player)}">${escapeHtml(state.player)}</span>.`, "line");
            addLine(`Please do not refresh.`, "warn");
            reduceSanity(1);
            await sleep(250);
            go("consent");
          }, {kind:"primary"});

          addChoice("Leave the field blank", async () => {
            addLine(`You refuse to name yourself. The page names you anyway.`, "accent");
            state.player = "UNNAMED";
            reduceSanity(1);
            await sleep(200);
            go("consent");
          }, {kind:"danger"});
        },

        consent: async () => {
          setStatus("prompt");
          clearChoices();

          const val = await modal(
            "PERMISSION REQUEST",
            `This document would like to use your attention.<br/><span class="dim">Allow?</span>`,
            [
              {label:"Allow", value:"allow", kind:"primary"},
              {label:"Deny", value:"deny", kind:"danger"},
            ]
          );

          if(val === "deny"){
            addLine(`You click <span class="glitch" data-text="DENY">DENY</span>.`, "line");
            await sleep(250);
            addLine(`The button remains pressed. The page continues anyway.`, "accent");
            reduceSanity(1);
            state.flags.add("denied");
          }else{
            addLine(`You click <span class="good">ALLOW</span>.`, "good");
            state.flags.add("allowed");
            restoreSanity(1);
          }

          addLine(`<span class="dim">A link appears.</span>`, "dim");
          clearChoices();
          addChoice("Open the link", () => go("link"), {kind:"primary"});
          addChoice("Don't open it", async () => {
            addLine(`You hover away. The link follows your eyes.`, "accent");
            reduceSanity(1);
            await sleep(250);
            go("link");
          });
        },

        link: async () => {
          setStatus("navigating");
          clearChoices();
          addLine(`The link is labeled: <span class="glitch" data-text="INDEX.HTML">INDEX.HTML</span>`, "line");
          await sleep(350);
          addLine(`But the address bar doesn't change.`, "dim");
          await sleep(350);
          addLine(`This is still the same page. It's just pretending to be somewhere else.`, "warn");

          clearChoices();
          addChoice("Inspect the source", async () => {
            addLine(`You try to look behind the curtain.`, "line");
            await sleep(250);
            addLine(`The curtain looks back.`, "accent");
            reduceSanity(1);
            go("cursor");
          }, {kind:"primary"});

          addChoice("Trust it", async () => {
            addLine(`You decide not to question it.`, "dim");
            restoreSanity(1);
            go("cursor");
          });
        },

        cursor: async () => {
          setStatus("listening");
          clearChoices();
          addLine(`A second cursor appears. It waits near the top-right corner.`, "line");
          addLine(`<span class="dim">It wants you to follow it.</span>`, "dim");
          setHint("Move your mouse slowly, then choose.");

          clearChoices();
          addChoice("Follow the second cursor", async () => {
            addLine(`You follow it.`, "line");
            await sleep(300);
            addLine(`It stops at an invisible button.`, "dim");
            chime();
            go("button");
          }, {kind:"primary"});

          addChoice("Ignore it", async () => {
            addLine(`You ignore it.`, "line");
            await sleep(300);
            addLine(`It moves anyway — closer to the center.`, "accent");
            reduceSanity(1);
            go("button");
          }, {kind:"danger"});
        },

        button: async () => {
          setStatus("event");
          clearChoices();
          addLine(`A button fades in: <span class="glitch" data-text="DO NOT CLICK">DO NOT CLICK</span>`, "warn");
          await sleep(250);
          addLine(`Under it, smaller text: <span class="dim">clicking is how you win</span>`, "dim");

          clearChoices();
          addChoice("Click it", async () => {
            addLine(`You click.`, "line");
            beep({freq:92,dur:0.12,gain:0.03,type:"square"});
            reduceSanity(1);
            await sleep(350);
            addLine(`The page flinches.`, "accent");
            go("form");
          }, {kind:"primary"});

          addChoice("Don't click", async () => {
            addLine(`Your finger hesitates.`, "dim");
            await sleep(350);
            addLine(`The button clicks itself.`, "accent");
            beep({freq:110,dur:0.11,gain:0.03,type:"triangle"});
            reduceSanity(1);
            go("form");
          }, {kind:"danger"});
        },

        form: async () => {
          setStatus("validation");
          clearChoices();
          addLine(`<span class="dim">A checklist appears, like an HTML form.</span>`, "dim");
          await sleep(200);

          // Create checkboxes inline
          const box = document.createElement("div");
          box.className = "line";
          box.style.marginTop = "8px";
          box.innerHTML = `
            <div class="dim" style="margin-bottom:8px;">Check exactly two boxes:</div>
            <label style="display:block;margin:6px 0;"><input type="checkbox" data-k="door" /> The door is closed.</label>
            <label style="display:block;margin:6px 0;"><input type="checkbox" data-k="light" /> The light is on.</label>
            <label style="display:block;margin:6px 0;"><input type="checkbox" data-k="alone" /> I am alone.</label>
            <label style="display:block;margin:6px 0;"><input type="checkbox" data-k="watched" /> I am being watched.</label>
          `;
          logEl.appendChild(box);
          screenEl.scrollTop = screenEl.scrollHeight;

          function checkedKeys(){
            return [...box.querySelectorAll("input[type=checkbox]")].filter(x=>x.checked).map(x=>x.dataset.k);
          }

          addChoice("Submit form", async () => {
            const keys = checkedKeys();
            if(keys.length !== 2){
              addLine(`Form error: expected 2, got ${keys.length}.`, "warn");
              beep({freq:70,dur:0.12,gain:0.03,type:"sawtooth"});
              reduceSanity(1);
              // tiny sabotage: auto-check "watched" sometimes
              if(!keys.includes("watched") && Math.random() < 0.4){
                const w = box.querySelector("input[data-k='watched']");
                w.checked = true;
                addLine(`The page helps you.`, "accent");
              }
              clearChoices();
              addChoice("Try again", () => go("form"), {kind:"primary"});
              addChoice("Give up", () => go("ending_giveup"), {kind:"danger"});
              return;
            }

            // Consequences
            if(keys.includes("alone")){
              addLine(`You check "I am alone."`, "line");
              await sleep(250);
              addLine(`The page disagrees.`, "accent");
              reduceSanity(2);
            } else {
              restoreSanity(1);
            }

            if(keys.includes("watched")){
              addLine(`At least you're honest.`, "warn");
              reduceSanity(1);
            }

            await sleep(300);
            go("timer");
          }, {kind:"primary"});

          addChoice("Refuse to fill it out", async () => {
            addLine(`You refuse. The page fills it out for you.`, "accent");
            reduceSanity(2);
            await sleep(500);
            go("timer");
          }, {kind:"danger"});
        },

        timer: async () => {
          setStatus("countdown");
          clearChoices();
          addLine(`<span class="dim">An HTML timer starts.</span>`, "dim");

          let t = 7;
          const timerLine = document.createElement("div");
          timerLine.className = "line";
          logEl.appendChild(timerLine);

          function render(){
            timerLine.innerHTML = `Time remaining: <span class="glitch" data-text="${t}">${t}</span>`;
            screenEl.scrollTop = screenEl.scrollHeight;
          }

          render();
          setHint("Don’t let it hit zero.");

          const interval = setInterval(() => {
            t--;
            render();
            if(t <= 3) beep({freq:130 + t*12, dur:0.05, gain:0.02, type:"triangle"});
            if(t <= 0){
              clearInterval(interval);
            }
          }, 900);

          addChoice("Stop the timer", async () => {
            clearInterval(interval);
            addLine(`You press STOP.`, "line");
            await sleep(250);
            addLine(`It doesn't stop. It just <span class="glitch" data-text="RESENTS">RESENTS</span> you.`, "accent");
            reduceSanity(1);
            go("captcha");
          }, {kind:"primary"});

          addChoice("Let it run", async () => {
            // wait until it hits 0
            while(t > 0) await sleep(200);
            addLine(`It reaches zero.`, "warn");
            await sleep(300);
            addLine(`Nothing happens. That's the worst part.`, "accent");
            reduceSanity(2);
            go("captcha");
          }, {kind:"danger"});
        },

        captcha: async () => {
          setStatus("verification");
          clearChoices();
          addLine(`<span class="dim">Verification required.</span>`, "dim");
          await sleep(250);

          // a creepy "captcha" that's solvable by reading carefully
          const phrase = pick([
            "THE HALLWAY IS LONG",
            "DON'T LOOK UP",
            "THE WALLS BREATHE",
            "SOMETHING IS BEHIND THE GLASS"
          ]);

          const target = phrase.replace(/[^A-Z]/g,"").slice(0,8); // deterministic-ish
          addLine(`Type the first 8 letters of this sentence (ignore spaces):`, "line");
          addLine(`<span class="glitch" data-text="${escapeHtml(phrase)}">${escapeHtml(phrase)}</span>`, "accent");

          const wrapper = document.createElement("div");
          wrapper.className = "line";
          wrapper.style.marginTop = "10px";
          wrapper.innerHTML = `
            <input id="cap" autocomplete="off" spellcheck="false"
              style="width:min(360px,90%);padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.35);color:var(--fg);font:inherit;outline:none;"
              placeholder="8 letters…" />
          `;
          logEl.appendChild(wrapper);
          screenEl.scrollTop = screenEl.scrollHeight;

          const cap = wrapper.querySelector("#cap");
          cap.focus();

          addChoice("Verify", async () => {
            const v = (cap.value || "").toUpperCase().replace(/[^A-Z]/g,"");
            if(v.slice(0,8) !== target){
              addLine(`Verification failed.`, "warn");
              addLine(`The page smiles without a mouth.`, "accent");
              beep({freq:60,dur:0.15,gain:0.04,type:"sawtooth"});
              reduceSanity(2);
              clearChoices();
              addChoice("Try again", () => go("captcha"), {kind:"primary"});
              addChoice("Run", () => go("ending_run"), {kind:"danger"});
              return;
            }
            addLine(`Verified.`, "good");
            chime();
            restoreSanity(1);
            go("finalChoice");
          }, {kind:"primary"});
        },

        finalChoice: async () => {
          setStatus("final");
          clearChoices();
          setHint("There are multiple endings.");

          addLine(`<span class="dim">A final menu appears.</span>`, "dim");
          addLine(`Choose how you want to "win":`, "line");

          addChoice("Close the page politely", async () => {
            addLine(`You attempt to close it like a normal person.`, "dim");
            await sleep(400);
            if(state.flags.has("denied")){
              addLine(`Politeness is not accepted after denial.`, "accent");
              reduceSanity(2);
              go("ending_loop");
            }else{
              go("ending_good");
            }
          }, {kind:"primary"});

          addChoice("Fight the page", async () => {
            addLine(`You push back.`, "line");
            await sleep(350);
            addLine(`The page pushes harder.`, "accent");
            reduceSanity(2);
            go("ending_fight");
          }, {kind:"danger"});

          addChoice("Say the secret word", async () => {
            addLine(`You try words like keys.`, "dim");
            await sleep(300);
            addLine(`The page wants one word: <span class="glitch" data-text="LIGHT">LIGHT</span>`, "line");
            addLine(`<span class="dim">Press the <b>L</b> key.</span>`, "dim");
            setHint("Press L, then click Continue.");

            clearChoices();
            addChoice("Continue", async () => {
              if(state.flags.has("pressed_l")){
                go("ending_secret");
              }else{
                addLine(`You didn't press it.`, "warn");
                reduceSanity(1);
                go("ending_loop");
              }
            }, {kind:"primary"});
          });
        },

        // ====== endings ======
        ending_good: async () => {
          setStatus("complete");
          clearChoices();
          setHint("");
          addLine(`<span class="good">WIN CONDITION MET</span>`, "good");
          addLine(`You closed the page without making it angry.`, "line");
          addLine(`It will remember that.`, "dim");
          addChoice("Play again", () => restart(), {kind:"primary"});
        },

        ending_secret: async () => {
          setStatus("complete");
          clearChoices();
          setHint("");
          addLine(`<span class="good">WIN CONDITION MET (SECRET)</span>`, "good");
          addLine(`The light doesn't chase shadows. It reveals them.`, "line");
          addLine(`For a moment, the page stops pretending.`, "dim");
          restoreSanity(4);
          addChoice("Play again", () => restart(), {kind:"primary"});
        },

        ending_run: async () => {
          setStatus("terminated");
          clearChoices();
          setHint("");
          addLine(`<span class="warn">ENDING: RUN</span>`, "warn");
          addLine(`You flee verification.`, "line");
          addLine(`In the next tab, you swear you see a second cursor again.`, "accent");
          reduceSanity(3);
          addChoice("Try again", () => restart(), {kind:"primary"});
        },

        ending_fight: async () => {
          setStatus("corrupted");
          clearChoices();
          setHint("");
          addLine(`<span class="warn">ENDING: FIGHT</span>`, "warn");
          addLine(`You punch the air. You slam keys.`, "line");
          addLine(`The page doesn't bruise. It just learns your rhythm.`, "accent");
          addLine(`<span class="dim">Some games are won by leaving.</span>`, "dim");
          addChoice("Leave (good idea)", () => restart(), {kind:"primary"});
        },

        ending_loop: async () => {
          setStatus("looping");
          clearChoices();
          setHint("");
          addLine(`<span class="warn">ENDING: LOOP</span>`, "warn");
          addLine(`The page scrolls you back to the beginning.`, "line");
          addLine(`Not all loops are circles. Some are cages.`, "accent");
          addChoice("Start over", () => restart(), {kind:"primary"});
        },

        ending_giveup: async () => {
          setStatus("stasis");
          clearChoices();
          setHint("");
          addLine(`<span class="warn">ENDING: GIVE UP</span>`, "warn");
          addLine(`You stop playing. The page keeps going.`, "accent");
          addLine(`It fills the silence with your own breathing.`, "dim");
          addChoice("Try again", () => restart(), {kind:"primary"});
        },
      };

      function escapeHtml(s){
        return String(s)
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#39;");
      }

      function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

      async function go(step){
        state.step = step;
        await nodes[step]();
      }

      function restart(){
        // reset UI and state except event listeners
        logEl.innerHTML = "";
        clearChoices();
        setHint("");
        setStatus("idle");
        glitchOn(false);
        eyes(false);
        setPanic(false);
        state.step = "boot";
        state.sanity = 6;
        state.flags = new Set();
        state.player = "YOU";
        state.startedAt = now();
        state.moves = 0;
        go("boot");
      }

      // ====== init ======
      attachUnsettlingEvents();

      // encourage audio unlock
      window.addEventListener("pointerdown", () => {
        if(audioCtx && audioCtx.state === "suspended") audioCtx.resume();
      }, {once:true});

      // start
      go("boot");
    })();
  </script>

  <div class="vignette"></div>
</body>
</html>
